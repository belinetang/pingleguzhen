<!DOCTYPE html>
<html lang="en">
<head>
    <%-include("common/headinfo.html",{h_tit:'平乐古镇·天台山旅游电子商务平台_特产详情'})%>
    <!-- 页面设计：陈建波| 页面重构：龚小虎 | 前端开发：何小贵 | 创建：2018-8-10 -->
</head>
<body>
<!--页头-->
<%-include("common/header.html")%>
<%-include("common/nav.html")%>
<div class="crumbs">
    <div class="js_curmbs center"></div>
</div>
<div class="daq-specialty-detail">
    <div class="center">
        <!--详情-->
        <div class="js_detail"></div>
    </div>
</div>
<!--页尾-->
<%-include("common/footer.html")%>
<!--特产详情tmpl-->
<script type="text/template" id="sTmpl">
    <div class="specialty-show">
        <div class="left-img-show">
            <div class="big-img">
                <img src="${data.cover || './image/zw.jpg'}" alt="">
            </div>
            <div class="scroll-content js_img_scroll">
                <ul class="scroll-ul">
                    {{each data.productImages}}
                    <li data-src="${large}"><img src="${thumbnail}" alt="${title}"></li>
                    {{/each}}
                </ul>
                <div class="left-btn daq-icon">&#xe6b2;</div>
                <div class="right-btn daq-icon">&#xe6b1;</div>
            </div>
        </div>
        <div class="right-classify">
            <h2 class="specialty-name">${data.name}</h2>
            <div class="specialty-price">
                销售价：
                <span class="price">&yen;<span class="js_price">${data.price}</span></span>
                <span class="original-price">原价:<span>&yen;${data.shopPrice}</span></span>
                <span class="sell-num">已售:${data.sales}</span>
            </div>
            <div class="specification-one clearfix js_specific">
                <p class="fl">${data.specific}：</p>
                <ul class="fl specification-list clearfix js_specific_list">
                    <!--<li class="active">玫瑰红</li>-->
                    {{each(i,e) data.sku}}
                    <li data-max="${e.maxBuyNum}" data-min="${e.minBuyNum}" data-price="${e.price}" data-stock="${e.stock}" data-specification="${e.specification}" data-idx="${i}" title="${title}">${ tools.ellipsisContent(title,4)}</li>
                    {{/each}}
                </ul>
            </div>
            <!--<div class="specification-one clearfix">-->
                <!--<p>规格二:</p>-->
                <!--<ul class="specification-list">-->
                    <!--<li class="active">200g</li>-->
                    <!--<li>500g</li>-->
                <!--</ul>-->
            <!--</div>-->
            <div class="bug-num">
                <span class="left-name">数量：</span>
                <!--<div class="add-minus">-->
                    <!--<i class="minus daq-icon">&#xe65d;</i>-->
                    <!--<span class="num">1</span>-->
                    <!--<i class="add daq-icon">&#xe65b;</i>-->
                <!--</div>-->
                <p class="daq-inp-operation dio-input mt-10 spec-inp-operation">
                    <input class="wid-138 js_quantity" type="text" value="1" maxlength="3"/>
                    <i class="sysfont inp-subtract dio-left dio-disable"></i><i class="sysfont dio-font"></i>
                </p>
                <span style="margin-left: 10px;display:none;" class="js_stock">库存（0）</span>
            </div>
            <div class="specialty-btn">
                <button class="now-bug js_buy">立即购买</button>
                <button class="add-cart js_cart">加入购物车</button>
                <!--<div class="goods-ewm">-->
                    <!--<i class="daq-icon">&#xe651;</i>-->
                    <!--<div class="ewm-img">-->
                        <!--<img src="image/goods-img.jpg" alt="">-->
                    <!--</div>-->
                <!--</div>-->
            </div>
            <div class="collect-share clearfix">
                <!--<span class="collect"><i class="daq-icon">&#xe697;</i>收藏</span>-->
                <ul class="sales-out">
                    {{each data.afterSalesService}}
                    <li>
                        <i class="daq-icon">&#xe600;</i>
                        <span>${afterSaleName}</span>
                    </li>
                    {{/each}}
                </ul>
                <span class="share" style="position: relative;">
            <i class="daq-icon">&#xe6db;</i>分享
            <label class="bdsharebuttonbox bdshare_t bds_tools_32" style="position: absolute;z-index: 10; top: -6px; display:  block; left: 0; width:0px; height:0px;" data-bd-bind="1471256152095">
                        <a class="bds_more" title="" data-img="" data-cmd="more" style="position: absolute;z-index:10; margin:0;padding:0;background: transparent;left: 0;top: 4px;width:90px;height:90px; display:inline-block; border: 0;background:red;opacity: 0;filter:Alpha(opacity=0)"></a>
                    </label>
        </span>
            </div>
        </div>
    </div>
    <!-- 特产参数 -->
    <!--房型介绍-->
    <div class="hotel-detail-price">
        <ul class="detail-nav">
            <li class="active">
                <a href="javascript:;" data-type="product">产品说明</a>
            </li>
            <li>
                <a href="javascript:;" data-type="feature">产品特色</a>
            </li>
            <li>
                <a href="javascript:;" data-type="sale">售后保障</a>
            </li>
        </ul>
        <div class="goods-state" id="product">
            {{html data.memo}}
        </div>
    </div>
    <!-- 产品特色 -->
    <div class="goods-special" id="feature">
        <h2 class="common-title">产品特色</h2>
        <div class="special-content">${data.sellingPoint}</div>
    </div>
    <!-- 售后保障 -->
    <div class="goods-special" id="sale">
        <h2 class="common-title">售后保障</h2>
        <div class="special-content">
            {{each data.afterSalesService}}
                ${afterSaleName}： {{html afterSaleMemo}}<br/>
            {{/each}}
        </div>
    </div>
</script>
<script>
var detail = {
    init: function(){
        tools.setTowLevelBanner();
        this.pid = tools.getUrlParams("id");
        this.sku_idx = 0;
        this.stock = 1;
        this.min = 1;
        this.max = 1;
        this.price = '';
        this.specification = '';
        this.getDetail();
    },
    getDetail: function(){
        var _this = this;
        $('.js_detail').renderHtml({
            url: 'ds/qiandnApi/specialty/view',
            type: true,
            template: $("#sTmpl"),
            params: {
                pid: tools.getUrlParams('id')
            },
            loading: true,
            callback: function (data) {
                var data = data.products;
                if(data.productImages.length > 0) {
                    data.cover = data.productImages[0].large;
                }
                return data;
            },
            complete: function(res){
                tools.share();
                _this.complete(res);
                _this.pageScroll();
            }
        })
    },
    complete: function(res){
        var _this = this;
        // 规格处理
        var $specific = $('.js_specific');
        var lw = $specific.find('p').width();
        var ww = $specific.width();
        $specific.find('ul').css('width', ww-lw-12);

        // 规格选择
        // 数量输入框控制
        this.operation = tools.inputCount({
            el: '.daq-inp-operation',
            max:1, // 最大值
            min:1
        });
        var $specificLi = $('.js_specific_list').find('li');
        $specificLi.on('click', function(){
            $(this).addClass('active').siblings('li').removeClass('active');
            var max = $(this).attr('data-max');
            var stock = $(this).attr('data-stock');
            _this.stock = stock;
            _this.min = $(this).attr('data-min');
            _this.max = max <= stock ? max : stock;
            _this.price = $(this).attr('data-price');
            _this.specification = $(this).attr('data-specification');
            _this.sku_idx = $(this).attr('data-idx');
            $('.js_price').html(_this.price);
            $('.js_stock').html('库存（'+ _this.stock +'）').show();

            // 更新数量输入框最大值最小值
            _this.operation.update({
                max: _this.max,
                min: _this.min
            });

        });
        $specificLi.eq(0).trigger("click");

        // 左侧图片处理
        if(res.data.products.productImages.length > 0){
            this.imgHover();
        } else {
            $('.js_img_scroll').hide();
        }

        _this.btnClick();
    },
    // 加入购物车 和立即购买 点击事件
    btnClick: function () {
        var _this = this;
        // 立即购买点击
        $('.js_buy').on('click', function () {
            tools.isLogin(function(){
                window.location.href = 'specialty-fillorder.html?id=' + tools.getUrlParams('id') + '&quantity=' + $('.js_quantity').val() + '&sku_idx=' + _this.sku_idx;
            });
        });
        // 加入购物车点击
        $('.js_cart').on('click', function () {
            tools.isLogin(function(){
                _this.add2Cart();
            });
        });
    },
    // 添加到购物车
    add2Cart: function(){
        var _this = this;
        var params = {
            url: 'ds/qiandnApi/cart/add',
            type: true,
            data: {
                token: tools.getCookie('token'),
                pid: this.pid,
                quantity: $('.js_quantity').val(),
                specification: this.specification
            }
        };
        tools.request(params, function (res) {
            if(res.code === 0) {
                $.daqMessage({
                    text: '已成功添加到购物车',
                    skin: 1,
                    position: 'center',
                    time: 1000
                });
                window.NavCartRender();
            } else if(res.code === 2) {
                tools.doLogin();
            } else {
                $.daqMessage({
                    text: res.message,
                    skin: 1,
                    position: 'center',
                    time: 1000
                });
            }
        });
    },
    // 左侧图片预览
    imgHover: function(){
        $(".scroll-ul li").eq(0).addClass('active');
        $(".scroll-ul li").mouseover(function () {
            var $src = $(this).attr("data-src");
            $(".big-img").find("img").attr("src",$src);
            $(this).addClass('active').siblings("li").removeClass('active');
        });
        $('.right-btn').on('click',function () {
            var $box = $('.scroll-ul')
            var leng = $('.scroll-ul li').length
            var $h = parseInt($box.css('marginLeft'))
            if($h == -(leng-6)*101 || leng <= 6){
                return false
            }
            $box.stop().css('marginLeft',$h-101 + 'px').css("transition","all .1s");
        });
        $('.left-btn').on('click',function () {
            var $box = $('.scroll-ul')
            var $h = parseInt($box.css('marginLeft'))
            var leng = $('.scroll-ul li').length
            if($h == 0 || leng <= 6){
                return false
            }
            $box.stop().css('marginLeft',$h+101 + 'px').css("transition","all .1s");
        });
    },
    // 下方选项卡点击页面滚动
    pageScroll: function() {
        var needPos = $(".detail-nav li");
        needPos.click(function () {
            needPos.removeClass("active");
            $(this).addClass("active");
            var dataType = $(this).find('a').attr("data-type");
            if($('.detail-nav').hasClass("curr")){
                $('html,body').animate({scrollTop: $("#" + dataType + "").offset().top-46}, 500);
            }else{
                $('html,body').animate({scrollTop: $("#" + dataType + "").offset().top-92}, 500);
            }
        });
        /*详情页面内容tit滚动判断固定位置*/
        var Scrolltop = $(".detail-nav").offset().top;
        $(window).scroll(function(){
            var bodyScrolltop = document.documentElement.scrollTop + document.body.scrollTop;
            if(bodyScrolltop >= Scrolltop){
                $(".detail-nav").addClass('curr');
            }else if(bodyScrolltop < Scrolltop){
                $(".detail-nav").removeClass('curr');
            }
        });
    }
};
$(function(){
    detail.init();
})

</script>
</body>
</html>
