<!DOCTYPE html>
<html lang="en">
<head>
    <%-include("common/headinfo.html",{h_tit:'河北旅游电商资讯网_个人中心'})%>
</head>
<body>
<!--页头-->
<%-include("common/header.html")%>
<div class="personalCenter-max personalCenter">
    <div class="center clearfix">
        <%-include("common/personal-nav.html")%>
        <div class="person-content min680 bg-w">
            <div class="nearorder">
                <div class="person-title mar24 clearfix">
                    <h3 class="fl">
                        退款管理
                    </h3>
                </div>
                <div class="order-search clearfix">
                    <span>退款编号：<input type="text" placeholder="请输入退款编号" class="js_sn"></span>
                    <span class="time">
                    订单时间：
                    <div class="daq-date">
                        <input class="date" id="start" placeholder="开始时间" readonly="readonly">
                        <i class="sysfont date-icon"></i>
                    </div> -
                     <div class="daq-date">
                        <input class="date" id="end" placeholder="结束时间" readonly="readonly">
                        <i class="sysfont date-icon"></i>
                    </div>
                    </span>
                    <a href="javascript:;" class="js_search">搜 索</a>
                </div>
                <table class="refundtable">
                    <thead>
                    <tr>
                        <th>退款编号</th>
                        <th>数量</th>
                        <th>金额</th>
                        <th>手续费</th>
                        <th>退款方式</th>
                        <th>退款时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody class="js_list">
                    </tbody>
                </table>
                <div class="page">
                </div>
            </div>
        </div>
    </div>
</div>
<!--页尾-->
<%-include("common/footer.html")%>
<script type="text/template" id="listTmp">
    {{each list}}
    <tr>
        <td>
            ${sn}
        </td>
        <td>
            {{if child}}
            成人：${quantity} 儿童：${child}
            {{else}}
            ${quantity}
            {{/if}}
        </td>
        <td class="amount">￥${refundsAmount}</td>
        <td class="amount gray">￥${fee}</td>
        <td>
            {{if method==='deposit'}}
            原路返回预存款
            {{else method==='wallet'}}
            原路返回钱包
            {{else method==='offline'}}
            原路返回到挂账
            {{else method==='collect'}}
            退现
            {{/if}}
        </td>
        <td class="time">${modifyDate}</td>
        <td>${state}</td>
        <td>
            <p class="btn-box">
                <a href="javascript:;" data-id="${id}" class="cancel-btn js_desc">查看详情</a>
            </p>
        </td>
    </tr>
    {{/each}}
</script>
<script>
    var refund = {
        init: function () {
            this.parmas = {
                page: 1,
                limitPage: 8,
                token: tools.getCookie('token'),
                sourceType: '',
                status:'',
                endDate:'',
                startDate:'',
                category:'',
                sn:''
            };
            this.loadList();
            this.eventBind();
        },
        eventBind: function () {
            var _this = this;
            $('.js_search').click(function () {
                _this.parmas.sn = $('.js_sn').val();
                _this.loadList();
            });
            var start =  laydate.render({
                elem: '#start',
                done: function(value, date){
                    _this.parmas.startDate = value;
                    if(value !== ''){
                        end.config.min.year = date.year;
                        end.config.min.month = date.month-1;
                        end.config.min.date = date.date;
                    }else{
                        end.config.min.year = '';
                        end.config.min.month = '';
                        end.config.min.date = '';
                    }
                }
            });
            var end = laydate.render({
                elem: '#end',
                done: function(value, date){
                    _this.parmas.endDate = value;
                    if (value !== ''){
                        start.config.max.year = date.year;
                        start.config.max.month = date.month-1;
                        start.config.max.date = date.date;
                    } else {
                        start.config.max.year = '';
                        start.config.max.month = '';
                        start.config.max.date = '';
                    }
                }
            });
        },
        loadList: function () {
            var _this = this,
                $box = $('.js_list');
            tools.request({
                url: 'ds/qiandnApi/order-pc/refundsList',
                data: _this.parmas,
                type: true
            },function (result) {
                $box.empty();
                if(result.code === 0){
                    $box.empty();
                    var list = result.datas;
                    if(list.length > 0){
                        $('#listTmp').tmpl({list: list}).appendTo($box);
                        $('.js_desc').off().click(function () {
                            _this.refdesc($(this).attr('data-id'));
                        });
                        //  初始化分页
                        var option = {
                            total: result.page.totalPage,
                            currPage: result.page.currPage,
                            click: function (data) {
                                page = data.page;
                                _this.parmas.page = data.page;
                                $(window).scrollTop(0);
                                _this.loadList();
                            }
                        };
                        tools.pageTurn(option);

                    }else{
                        $box.html("<tr><td colspan='8'>"+tools.NO_DATA1+"</td></tr>");
                        $('.page').html("");
                    }
                }else{
                    $box.html(tools.TRY_REFRESH)
                }
            })
        },
        refdesc:function (id) {
            tools.request({
                url: 'ds/qiandnApi/order-pc/refundsDetail',
                data: {
                    token: tools.getCookie('token'),
                    id: id
                },
                type: true
            },function (result) {
                if(result.code === 0){
                    var data = result.data;
                    window.location.href = "personalCenter-applyrefund.html?orderId="+data.orderId
                }else{
                    $box.html(tools.TRY_REFRESH)
                }
            })
        }
    };
    $(function () {
        refund.init();
    })
</script>
</body>
</html>
